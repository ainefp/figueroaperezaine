<script setup>
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import { useCestaStore } from "../store/cesta";
import logo from "../assets/logo.png";
import { addFactura } from "../api/facturas";
import { onMounted, ref } from "vue";
// Creamos la cesta para usar metodos y datos
const cestaStore = useCestaStore();
//Como ya no queremos los datos visibles(vaciar iconos y cesta), pasamos los datos a la variable invisible
cestaStore.completarCompra();

const facturaGuardada = ref(false);

async function guardarFacturaMongo() {
  if (facturaGuardada.value || cestaStore.compraCompleta.length === 0) return;

  try {
    const factura = {
      productos: cestaStore.compraCompleta.map((producto) => ({
        productoId: producto._id || producto.id,
        nombre:
          producto.nombre || `${producto.marca ?? ""} ${producto.modelo ?? ""}`,
        cantidad: producto.cantidad,
        precio_unitario: producto.precio,
      })),
      total: cestaStore.totalPrecio,
    };
    await addFactura(factura);
    facturaGuardada.value = true;
    console.log("Factura guardada en MongoDB");
  } catch (error) {
    console.error("Error guardando la factura", error);
  }
}

onMounted(async () => {
  await guardarFacturaMongo();
});

//Metodo que genera un pdf en base a los datos que le pasamos.
async function generarFacturaPdf() {
  //Asociamos el array de items no visible a la variable cart
  const cart = cestaStore.compraCompleta;

  //Si no tiene elementos mostramos alert
  if (cart.length === 0) {
    alert("No hay productos para facturar");
    return;
  }

  //Creamos pdf y seteamos las propiedades
  const doc = new jsPDF();

  // Logo y encabezado
  doc.addImage(logo, "png", 10, 10, 20, 20);
  doc.setFontSize(18);
  doc.text("Factura de Compra", 60, 20);
  doc.setFontSize(9);
  doc.text("Razón Social: Regalos Teis", 110, 50);
  doc.text("Dirección: Avenida Galicia 101, Vigo - 36216", 110, 55);
  doc.text("Tlfo: 986 666 333 - Email: regalos@example.com", 110, 60);

  // Tabla de productos, marcará los headers de cada tabla
  const headers = [["ID", "Producto", "Cantidad", "Precio Unitario", "Total"]];
  //Formatea los datos para ser visibles, es un array de objetos
  const data = cart.map((item) => [
    item.id,
    item.nombre,
    item.cantidad,
    `${item.precio.toFixed(2)}€`,
    `${(item.cantidad * item.precio).toFixed(2)}€`,
  ]);

  //Creamos tabla en base a los headers y datos
  autoTable(doc, {
    startY: 80,
    head: headers,
    body: data,
    columnStyles: {
      0: { halign: "center" },
      2: { halign: "center" },
      3: { halign: "right" },
      4: { halign: "right" },
    },
    theme: "striped",
  });

  // Coger los datos para poner en el documento, el total vendrá del compraCompleta ya que el otro estará vacío
  const totalPrice = cestaStore.totalPrecio;
  const totalText = `Total: ${totalPrice.toFixed(2)}€`;
  const pageWidth = doc.internal.pageSize.width;
  const totalWidth = doc.getTextWidth(totalText);
  const positionX = pageWidth - totalWidth - 14;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text(totalText, positionX - 9, doc.lastAutoTable.finalY + 10);

  //Guardamos el pdf
  doc.save("factura.pdf");

  //Limpuamos ambas listas y el sessionStorage
  cestaStore.clearCesta();
}
</script>